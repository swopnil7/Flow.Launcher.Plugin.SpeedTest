name: Release

on:
  push:
    branches: [ main ]
    paths:
      - 'plugin.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from plugin.json
        id: version
        uses: notiz-dev/github-action-json-property@v0.2.0
        with:
          path: plugin.json
          prop_path: Version

      - name: Check if release exists
        id: check
        shell: pwsh
        run: |
          $version = '${{ steps.version.outputs.prop }}'
          $tagName = "v$version"
          
          Write-Host "Version in plugin.json: $version"
          Write-Host "Checking for tag: $tagName"
          
          git fetch --tags
          $tagExists = git tag -l $tagName
          
          if ($tagExists) {
            Write-Host "❌ Tag $tagName already exists - stopping workflow"
            exit 1
          } else {
            Write-Host "✅ Tag $tagName does not exist - proceeding with release"
          }

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        shell: pwsh
        run: |
          dotnet restore Flow.Launcher.Plugin.SpeedTest.csproj --source https://api.nuget.org/v3/index.json

      - name: Build
        shell: pwsh
        run: |
          dotnet build Flow.Launcher.Plugin.SpeedTest.csproj -c Release
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Package plugin
        shell: pwsh
        env:
          VERSION: ${{ steps.version.outputs.prop }}
        run: |
          $pluginName = "Flow.Launcher.Plugin.SpeedTest"
          $zipFile = "$pluginName-$env:VERSION.zip"
          $staging = "package-staging"
          
          New-Item -ItemType Directory $staging | Out-Null
          
          Copy-Item ".\bin\Release\Flow.Launcher.Plugin.SpeedTest.dll" $staging -Force
          Copy-Item ".\plugin.json" $staging -Force
          
          if (Test-Path ".\icon-light.png") {
            Copy-Item ".\icon-light.png" $staging -Force
          }
          if (Test-Path ".\icon-dark.png") {
            Copy-Item ".\icon-dark.png" $staging -Force
          }
          
          Compress-Archive -Path "$staging\*" -DestinationPath $zipFile -Force
          Remove-Item $staging -Recurse -Force
          
          Write-Host "✅ Package created: $zipFile"

      - name: Prepare release notes
        id: release_body
        shell: pwsh
        run: |
          if (Test-Path CHANGELOG.md) {
            $body = Get-Content -Raw -Path "CHANGELOG.md"
          } else {
            $body = "Release version ${{ steps.version.outputs.prop }}"
          }
          
          $delimiter = "EOF_$(Get-Random)"
          "body<<$delimiter" >> $env:GITHUB_OUTPUT
          $body >> $env:GITHUB_OUTPUT
          $delimiter >> $env:GITHUB_OUTPUT

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.prop }}
          name: "v${{ steps.version.outputs.prop }}"
          body: ${{ steps.release_body.outputs.body }}
          files: Flow.Launcher.Plugin.SpeedTest-${{ steps.version.outputs.prop }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}