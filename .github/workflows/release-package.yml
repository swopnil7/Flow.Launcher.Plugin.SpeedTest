name: Publish Release
on:
  push:
    branches: [ main ]
    paths-ignore:
      - .github/workflows/*
      - .gitignore
      - idea/*
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read version from plugin.json
        id: version
        uses: notiz-dev/github-action-json-property@v0.2.0
        with:
          path: plugin.json
          prop_path: Version

      - name: Fetch latest release version
        id: latest
        uses: reloc8/action-latest-release-version@1.0.0

      - name: Check if release is required
        id: check
        shell: pwsh
        run: |
          $new = '${{ steps.version.outputs.prop }}'
          $old = '${{ steps.latest.outputs.latest_version }}'.TrimStart('v')
          if ($new -ne $old) {
            "required=true" >> $env:GITHUB_OUTPUT
          } else {
            "required=false" >> $env:GITHUB_OUTPUT
          }

      - name: Setup .NET
        if: steps.check.outputs.required == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        if: steps.check.outputs.required == 'true'
        shell: pwsh
        run: |
          dotnet restore Flow.Launcher.Plugin.SpeedTest.csproj --source https://api.nuget.org/v3/index.json

      - name: Build
        if: steps.check.outputs.required == 'true'
        shell: pwsh
        run: |
          dotnet build Flow.Launcher.Plugin.SpeedTest.csproj -c Release
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Package plugin
        if: steps.check.outputs.required == 'true'
        shell: pwsh
        env:
          VERSION: ${{ steps.version.outputs.prop }}
        run: |
          $pluginName = "Flow.Launcher.Plugin.SpeedTest"
          $zipFile = "$pluginName-$env:VERSION.zip"
          $staging = "package-staging"
          New-Item -ItemType Directory $staging | Out-Null
          Copy-Item ".\bin\Release\Flow.Launcher.Plugin.SpeedTest.dll" $staging -Force
          Copy-Item ".\plugin.json" $staging -Force
          if (Test-Path ".\icon-light.png") { Copy-Item ".\icon-light.png" $staging -Force }
          if (Test-Path ".\icon-dark.png") { Copy-Item ".\icon-dark.png" $staging -Force }
          # Compress the staging folder contents so files are at zip root
          Compress-Archive -Path "$staging\*" -DestinationPath $zipFile -Force
          Remove-Item $staging -Recurse -Force
          Write-Host "Package created: $zipFile"

      - name: Prepare release notes
        if: steps.check.outputs.required == 'true'
        id: release_body
        shell: pwsh
        run: |
          if (Test-Path CHANGELOG.md) {
              $body = Get-Content -Raw -Path "CHANGELOG.md"
              # Proper way to write multiline output
              Add-Content -Path $env:GITHUB_OUTPUT -Value "body<<EOH"
              Add-Content -Path $env:GITHUB_OUTPUT -Value $body
              Add-Content -Path $env:GITHUB_OUTPUT -Value "EOH"
          } else {
              Write-Output "body=feat: dynamic icon switching based on application theme" >> $env:GITHUB_OUTPUT
          }

      - name: Publish GitHub Release
        if: steps.check.outputs.required == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.prop }}
          name: "${{ steps.version.outputs.prop }}"
          body: ${{ steps.release_body.outputs.body }}
          files: Flow.Launcher.Plugin.SpeedTest-${{ steps.version.outputs.prop }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
